<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <title>A useful OPA snippet for selecting user-created resources - blog.skouf.com</title>
  <meta name="generator" content="Hugo 0.80.0" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="Nik Skoufis">
  
  <meta name="description" content="Documenting a neat solution to the problem of enforcing OPA policies against resources, but only when they have been created by a user (as opposed to those created by an internal Kubernetes controller)">
  
  <meta name="keywords" content="">
  <meta property="og:site_name" content="blog.skouf.com">
  <meta property="og:title" content="A useful OPA snippet for selecting user-created resources">
  <meta property="og:url" content="https://blog.skouf.com/posts/opa-user-created-resources/">
  
  <meta property="og:image" content="https://blog.skouf.com/post.jpg">
  
  
  <meta property="og:description" content="Documenting a neat solution to the problem of enforcing OPA policies against resources, but only when they have been created by a user (as opposed to those created by an internal Kubernetes controller)">
  
  <meta property="og:type" content="blog">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:creator" content="@niksko">
  <meta name="twitter:title" content="A useful OPA snippet for selecting user-created resources">
  <meta name="twitter:url" content="https://blog.skouf.com/posts/opa-user-created-resources/">
  
  <meta name="twitter:description" content="Documenting a neat solution to the problem of enforcing OPA policies against resources, but only when they have been created by a user (as opposed to those created by an internal Kubernetes controller)">
  
  
  <meta name="twitter:image:src" content="https://blog.skouf.com/post.jpg">
  
  <link rel="shortcut icon" href="/image/theme/favicon.ico">
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css">
  <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/grids-responsive-min.css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/syntax.css">
  <link rel="alternate" href="https://blog.skouf.com/index.xml" type="application/rss+xml" title="blog.skouf.com">
</head>

<body>
<div id="wrap" class="wrap">
  <header class="header">
  <div class="site-title"><a href="/">blog.skouf.com</a></div>
  <p class="site-desc">The personal blog of Nik Skoufis</p>
  
</header>

  <main class="main main--single">
    
    <article class="post"ã€€itemscope itemtype="http://schema.org/BlogPosting">
      <h1 class="post__title">A useful OPA snippet for selecting user-created resources</h1>
<p class="post__date">
  <time itemprop="datePublished" datetime="2023-07-02T11:06:26Z">2023.07.02</time>
</p>

      <div class="post-content">
        



























<figure>
    
        <img 
          sizes="(min-width: 35em) 1200px, 100vw"
            srcset='
              
                /posts/opa-user-created-resources/post_hu3d03a01dcc18bc5be0e67db3d8d209a6_1654431_500x0_resize_q75_box.jpg 500w
              
              
                  , /posts/opa-user-created-resources/post_hu3d03a01dcc18bc5be0e67db3d8d209a6_1654431_800x0_resize_q75_box.jpg 800w
              
              
                  , /posts/opa-user-created-resources/post_hu3d03a01dcc18bc5be0e67db3d8d209a6_1654431_1200x0_resize_q75_box.jpg 1200w
              
              
                  , /posts/opa-user-created-resources/post_hu3d03a01dcc18bc5be0e67db3d8d209a6_1654431_1500x0_resize_q75_box.jpg 1500w 
              '
              
                  src="/posts/opa-user-created-resources/post.jpg" 
               alt="A photo of a sunset with the silhouette of a signpost"><figcaption>
                
                <p>
                    Photo by <a href="https://unsplash.com/@soymeraki">Javier Allegue Barros</a> on <a href="https://unsplash.com/photos/C7B-ExXpOIEnt">Unsplash</a>
                    
                        
                        </p>
                
            </figcaption></figure>

<p>At <a href="https://www.seek.com.au/work-for-seek/">work</a> we&rsquo;re continuing to use <a href="https://open-policy-agent.github.io/gatekeeper/website/docs/">OPA Gatekeeper</a>
in our Kubernetes clusters to enforce policy on the resources that are deployed there.</p>
<p>As I documented in <a href="https://blog.skouf.com/posts/opa-gatekeeper-gotcha/">my previous post on broad Gatekeeper policies</a>,
one of the things we want to do is enforce wide-ranging policy across all resources of a particular <code>Kind</code>.
For example, we might want to enforce that all resources created in the cluster have a label that indicates who the
owner of the resource is.</p>
<p>When this becomes challenging is when you run in to situations where your users are not the only entities creating
resources in the cluster.
And this is a surprisingly common occurrence, as I wrote about in my previous blog post.
Kubernetes contains many internal controllers that watch for resources that users typically create like <code>Deployment</code>s,
and in response create resources like <code>ReplicaSet</code>s (and then in turn, the <code>Pod</code>s you wanted).
Suddenly, your nice policy that enforces that every resource must have a <code>metadata.my-company.com/owner</code> label is
impossible to enforce on every resource, because there&rsquo;s no way to tell the Kubernetes <code>ReplicaSet</code> controller to
add this label to resources it creates.</p>
<p>In my <a href="https://blog.skouf.com/posts/opa-gatekeeper-gotcha/">my previous post</a> I suggested a few options for solving this
problem, but after some experimentation I&rsquo;ve discovered a much better solution.
This solution uses the <code>managedFields</code> property that was introduced to Kubernetes standard metadata in Kubernetes
1.18 to determine whether a resource has been created by a user.</p>
<p>This solution is specifically designed for GitOps environments, where there is a single entity that ultimately
creates resources on behalf of users.
I <em>think</em> you could use this in environments were developers create resources directly, but you&rsquo;d need to adapt it
to have a much longer list of managed field owners that trigger the enforcement.</p>
<h2 id="kubernetes-managedfields">Kubernetes <code>managedFields</code></h2>
<p>The trick to this post is that since Kubernetes 1.18, Kubernetes records which actor has changed a field on a resource.
<a href="https://kubernetes.io/blog/2020/04/01/kubernetes-1.18-feature-server-side-apply-beta-2/">https://kubernetes.io/blog/2020/04/01/kubernetes-1.18-feature-server-side-apply-beta-2/</a>
As an example, a simple <code>ConfigMap</code> with managed fields might look like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test-cm</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">test-label</span><span class="p">:</span><span class="w"> </span><span class="l">test</span><span class="w">
</span><span class="w">  </span><span class="nt">managedFields</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">manager</span><span class="p">:</span><span class="w"> </span><span class="l">kubectl</span><span class="w">
</span><span class="w">      </span><span class="nt">operation</span><span class="p">:</span><span class="w"> </span><span class="l">Apply</span><span class="w">
</span><span class="w">      </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w">      </span><span class="nt">time</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;2010-10-10T0:00:00Z&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">fieldsType</span><span class="p">:</span><span class="w"> </span><span class="l">FieldsV1</span><span class="w">
</span><span class="w">      </span><span class="nt">fieldsV1</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">f:metadata</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">f:labels</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">f:test-label</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span><span class="w">        </span><span class="nt">f:data</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">f:key</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">some value</span><span class="w">
</span></code></pre></div><p>Note that as of modern versions of <code>kubectl</code>, you&rsquo;ll need to pass the <code>--show-managed-fields</code> flag, otherwise <code>kubectl</code>
won&rsquo;t show you the <code>managedFields</code> field of the resources you view.
People got upset that they had a bunch more noise in their <code>kubectl</code> outputs when this feature was added, so they put
it behind a flag.</p>
<p>What&rsquo;s nice about <code>managedFields</code> is that we can now determine who is responsible for setting values on a particular
Kubernetes object.
And if an entity who is capable of complying with the policy constraints we would like to enforce has set some of
those fields, then we can choose to enforce our policy constraint.
If the resource consists entirely of fields that are set by an entity that can&rsquo;t comply with these policy
constraints, such as a Kubernetes internal controller, then we can ignore the resource.</p>
<h2 id="enforcing-constraints-on-user-created-resources-using-managedfields">Enforcing constraints on user-created resources using <code>managedFields</code></h2>
<p>The OPA required to make this work is fairly straightforward.</p>
<pre><code class="language-rego" data-lang="rego"># Set this based on the user that creates resources on behalf of your users
user_manager := &quot;some-user-manager&quot;

has_user_managed_fields(managed_fields, user_manager_name) {
	some i
	managed_fields_entry := managed_fields[i]
	managed_fields_entry.manager == user_manager_name
}

violation[{&quot;msg&quot;: msg, &quot;details&quot;: {}}] {
	has_user_managed_fields(input.review.object.metadata.managedFields, user_manager)
	# Add any rules here that should only apply to user-created resources
	msg := sprintf(&quot;&lt;some violation messae&gt;&quot;)
}
</code></pre><p>The <code>has_user_managed_fields</code> rule will ensure that at least one of the managed fields entries has a manager that
matches whatever you define to be a manager that indicates that the resource was created by a user.
For example, if you&rsquo;re using ArgoCD as your GitOps tool, any resource created by ArgoCD on behalf of users will have
many of its fields managed by <code>argocd-controller</code>.
Resources like the default <code>ServiceAccount</code> or <code>ReplicaSet</code>s which are created on behalf of users by Kubernetes
internal controllers will not match the <code>has_user_managed_fields</code> rule, and so will be exempt from the constraint.</p>
<p>This has worked quite well for us across a few different constraints.
If you&rsquo;re using something that lets you easily share policy between constraints as libraries like
<a href="https://github.com/plexsystems/konstraint">Konstraint</a>, I&rsquo;d suggest putting this functionality in a library that
you share around to your policies, because you&rsquo;ll likely end up writing it a lot for policies that are wide-ranging
like enforcing metadata across all resources.</p>
<p>Hopefully this helps you when designing your Gatekeeper policies!</p>

      </div>
    </article>
    
    <hr class="post-hr">
    
<nav class="post-nav">
  <ol class="pure-g">
    
      <li class="pure-u-1 pure-u-md-1-2 post-nav-prev">
      </li>
    
    
      <li class="pure-u-1 pure-u-md-1-2 post-nav-next">
        <a href="https://blog.skouf.com/posts/engineering-levels/">
          <span class="post-nav-label">Previous</span>
          <span class="post-nav-title">
                Engineering levels
              </span>
        </a>
      </li>
    
  </ol>
  <div class="post-nav-back">
    <a class="pure-button" href="/">Back</a>
  </div>
</nav>


  </main>
  <footer class="footer">
  <section class="author">
    <h2>Author</h2>
    <div class="pure-g">
      <div class="author__image pure-u-1-5 pure-u-md-1-8">
        <img src="/image/theme/author.jpg" alt="">
      </div>
      <div class="author__info pure-u-4-5 pure-u-md-7-8">
        
        <h3>Nik Skoufis</h3>
        
        
        <p>Software developer, hardware hacker, food lover</p>
        
        <ul class="author__links">
          
          <li>
            <a href="https://github.com/niksko" target="_blank">
              <img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/PjxzdmcgaGVpZ2h0PSIxMDI0IiB3aWR0aD0iMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNNTEyIDBDMjI5LjI1IDAgMCAyMjkuMjUgMCA1MTJjMCAyMjYuMjUgMTQ2LjY4OCA0MTguMTI1IDM1MC4xNTYgNDg1LjgxMiAyNS41OTQgNC42ODggMzQuOTM4LTExLjEyNSAzNC45MzgtMjQuNjI1IDAtMTIuMTg4LTAuNDY5LTUyLjU2Mi0wLjcxOS05NS4zMTJDMjQyIDkwOC44MTIgMjExLjkwNiA4MTcuNSAyMTEuOTA2IDgxNy41Yy0yMy4zMTItNTkuMTI1LTU2Ljg0NC03NC44NzUtNTYuODQ0LTc0Ljg3NS00Ni41MzEtMzEuNzUgMy41My0zMS4xMjUgMy41My0zMS4xMjUgNTEuNDA2IDMuNTYyIDc4LjQ3IDUyLjc1IDc4LjQ3IDUyLjc1IDQ1LjY4OCA3OC4yNSAxMTkuODc1IDU1LjYyNSAxNDkgNDIuNSA0LjY1NC0zMyAxNy45MDQtNTUuNjI1IDMyLjUtNjguMzc1QzMwNC45MDYgNzI1LjQzOCAxODUuMzQ0IDY4MS41IDE4NS4zNDQgNDg1LjMxMmMwLTU1LjkzOCAxOS45NjktMTAxLjU2MiA1Mi42NTYtMTM3LjQwNi01LjIxOS0xMy0yMi44NDQtNjUuMDk0IDUuMDYyLTEzNS41NjIgMCAwIDQyLjkzOC0xMy43NSAxNDAuODEyIDUyLjUgNDAuODEyLTExLjQwNiA4NC41OTQtMTcuMDMxIDEyOC4xMjUtMTcuMjE5IDQzLjUgMC4xODggODcuMzEyIDUuODc1IDEyOC4xODggMTcuMjgxIDk3LjY4OC02Ni4zMTIgMTQwLjY4OC01Mi41IDE0MC42ODgtNTIuNSAyOCA3MC41MzEgMTAuMzc1IDEyMi41NjIgNS4xMjUgMTM1LjUgMzIuODEyIDM1Ljg0NCA1Mi42MjUgODEuNDY5IDUyLjYyNSAxMzcuNDA2IDAgMTk2LjY4OC0xMTkuNzUgMjQwLTIzMy44MTIgMjUyLjY4OCAxOC40MzggMTUuODc1IDM0Ljc1IDQ3IDM0Ljc1IDk0Ljc1IDAgNjguNDM4LTAuNjg4IDEyMy42MjUtMC42ODggMTQwLjUgMCAxMy42MjUgOS4zMTIgMjkuNTYyIDM1LjI1IDI0LjU2MkM4NzcuNDM4IDkzMCAxMDI0IDczOC4xMjUgMTAyNCA1MTIgMTAyNCAyMjkuMjUgNzk0Ljc1IDAgNTEyIDB6Ii8+PC9zdmc+" alt="">
            </a>
          </li>
          
          
          <li>
            <a href="https://twitter.com/niksko" target="_blank">
              <img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/PjxzdmcgaGVpZ2h0PSI1MDAiIGlkPSJzdmcyIiB2ZXJzaW9uPSIxLjEiIHdpZHRoPSI1MDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6Y2M9Imh0dHA6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL25zIyIgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIiB4bWxuczppbmtzY2FwZT0iaHR0cDovL3d3dy5pbmtzY2FwZS5vcmcvbmFtZXNwYWNlcy9pbmtzY2FwZSIgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIiB4bWxuczpzb2RpcG9kaT0iaHR0cDovL3NvZGlwb2RpLnNvdXJjZWZvcmdlLm5ldC9EVEQvc29kaXBvZGktMC5kdGQiIHhtbG5zOnN2Zz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxkZWZzIGlkPSJkZWZzNCIvPjxnIGlkPSJsYXllcjEiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAsLTU1Mi4zNjIxOCkiPjxyZWN0IGhlaWdodD0iNTAwIiBpZD0icmVjdDI5OTAtMSIgcng9IjI1MCIgcnk9IjI1MCIgc3R5bGU9ImZpbGw6IzU1YWNlZTtmaWxsLW9wYWNpdHk6MTtzdHJva2U6bm9uZSIgd2lkdGg9IjUwMCIgeD0iMCIgeT0iNTUyLjM2MjE4Ii8+PGcgaWQ9ImxheWVyMS05IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtNTQ5LjAwNTE1LDgwLjI5NDM3MikiLz48ZyBpZD0ibGF5ZXIxLTYiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC01NzUuNzE0MjksMzkuOTk5OTk5KSIvPjxnIGlkPSJsYXllcjEtOTMiIHRyYW5zZm9ybT0ibWF0cml4KDAuOTk5Mjg5NDUsMCwwLDAuOTk5Mjg5NDUsNDc0LjcwMDIsLTQwLjgxOTI4KSIvPjxwYXRoIGQ9Im0gMzA5Ljg1LDY3Mi4zMTIxOCBjIC0zNS40NzA3OSwwLjg5ODc5IC02My45MjUsMjkuOTMxMzggLTYzLjkyNSw2NS42MjUgMCw1LjEzODI3IDAuNTUxMjIsMTAuMTYxNTYgMS42NzUsMTQuOTc1IC01NC41NjU2NywtMi43NDEyNiAtMTAyLjk0Mjg3LC0yOC44Nzc0OSAtMTM1LjMyNSwtNjguNiAtNS42NTE0Nyw5LjY5MTkxIC04LjksMjAuOTgxNTggLTguOSwzMy4wMjUgMCwyMi43NzQ2NyAxMS42MDgwOSw0Mi44NTQzOCAyOS4yMjUsNTQuNjI1IC0xMC43NTcyMiwtMC4zNDQyOCAtMjAuODk2MDYsLTMuMzA3NTggLTI5Ljc1LC04LjIyNSAtMC4wMDUsMC4yNzI4MiAwLDAuNTcwNjkgMCwwLjg1IDAsMzEuODA0MDIgMjIuNjM3OSw1OC4zMDg4IDUyLjY3NSw2NC4zNSAtNS41MDg1MiwxLjQ5NDA2IC0xMS4zMTA3NSwyLjMgLTE3LjMsMi4zIC00LjIzNTM0LDAgLTguMzQyMDMsLTAuNDAxOTggLTEyLjM1LC0xLjE3NSA4LjM2MDIyLDI2LjA4MTA5IDMyLjU3NTA2LDQ1LjA3Mzg1IDYxLjMsNDUuNiAtMjIuNDY5MzcsMTcuNjEwNDMgLTUwLjczNTM0LDI4LjEgLTgxLjUsMjguMSAtNS4yOTQxNiwwIC0xMC41MzY3NSwtMC4yODkzOCAtMTUuNjc1LC0wLjkgMjkuMDYyNzIsMTguNjM2ODMgNjMuNTUyODIsMjkuNSAxMDAuNjI1LDI5LjUgMTIwLjc2NTUyLDAgMTg2LjgsLTEwMC4wNDA1OCAxODYuOCwtMTg2LjggMCwtMi44NDUyIC0wLjA1MTcsLTUuNzA1NzcgLTAuMTc1LC04LjUyNSAxMi44MjI5NCwtOS4yMzcyIDIzLjk1NDU0LC0yMC44MDc3NiAzMi43NSwtMzMuOTc1IC0xMS43NjQxLDUuMjI5MjIgLTI0LjQxNTg2LDguNzcxNDYgLTM3LjcsMTAuMzUgMTMuNTYzNDYsLTguMTE5OSAyMy45NzA2MSwtMjAuOTgxNjYgMjguODc1LC0zNi4zMjUgLTEyLjY4NjUyLDcuNTI4NzcgLTI2LjczOTkzLDEzLjAwMDg1IC00MS43LDE1Ljk1IC0xMS45NzE5NywtMTIuNzU3OTggLTI5LjA0MTM3LC0yMC43MjUgLTQ3LjkyNSwtMjAuNzI1IC0wLjU2NjQ2LDAgLTEuMTM2OTgsLTAuMDE0MyAtMS43LDAgeiIgaWQ9InJlY3QyOTg5IiBzdHlsZT0iZmlsbDojZmZmZmZmO2ZpbGwtb3BhY2l0eToxO3N0cm9rZTpub25lIi8+PC9nPjwvc3ZnPg==" alt="">
            </a>
          </li>
          
          
        </ul>
      </div>
    </div>
  </section>
  <small>Â©blog.skouf.com</small>
</footer>

</div>

<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-76961630-4', 'auto');
	ga('send', 'pageview');
</script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script src="/js/script.js"></script>

</body>
</html>
